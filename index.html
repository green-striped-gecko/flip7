<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Score Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f7faff;
      color: #333;
      margin: 0;
      padding: 10px;
    }
    .players-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 500px;
    }
    .player {
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 6px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .player.selected {
      border-color: #3498db;
      background-color: #e8f4fd;
    }
    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .player-info {
      flex-grow: 1;
      font-size: 0.95em;
      text-align: left;
      padding: 0 10px;
    }
    .score-line {
      font-size: 1.5em;
      font-weight: bold;
      line-height: 1;
    }
    .queued-points {
      font-size: 1em;
      color: #27ae60;
      line-height: 1;
    }
    .btn-action {
      font-size: 1.2em;
      padding: 10px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      min-width: 44px;
    }
    .btn-add { background-color: #e17055; color: white; }
    .btn-add:hover { background-color: #d35400; }
    .btn-delete { background-color: #636e72; color: white; }
    .btn-delete:hover { background-color: #2d3436; }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      width: 100%;
      margin-top: 6px;
    }
    .button-grid button,
    .action-buttons button,
    .player-manage-buttons button {
      font-size: 1.1em;
      padding: 10px;
      border-radius: 10px;
      background-color: #6c5ce7;
      color: white;
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .button-grid button:active,
    .action-buttons button:active,
    .player-manage-buttons button:active {
      transform: scale(0.93);
      box-shadow: 0 0 0 4px #a29bfe;
    }
    .double-button {
      width: 100%;
      margin-top: 6px;
    }
    .double-button button {
      background-color: #00b894;
      font-size: 1.1em;
      padding: 10px;
      border-radius: 10px;
      width: 100%;
      color: white;
      border: none;
      cursor: pointer;
    }
    .action-buttons, .player-manage-buttons {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<audio id="clickSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>

<div class="players-column" id="players"></div>
<div class="action-buttons">
  <button onclick="undo()">‚Ü©Ô∏è Undo</button>
  <button onclick="resetAll()">üîÑ Reset</button>
</div>
<div class="player-manage-buttons">
  <button onclick="addPlayer()">‚ûï Add Player</button>
  <button onclick="deletePlayer()">üóëÔ∏è Delete Player</button>
</div>

<script>
  let playerNames = ['Alica', 'Bernd', 'Jonas', 'Mattis'];
  let scores = playerNames.map(() => 0);
  let queue = [];
  let history = playerNames.map(() => []);
  let currentPlayer = 0;

  const clickSound = document.getElementById("clickSound");

  function renderPlayers() {
    const container = document.getElementById("players");
    container.innerHTML = '';

    for (let i = 0; i < playerNames.length; i++) {
      const div = document.createElement("div");
      div.className = "player" + (i === currentPlayer ? " selected" : "");
      div.onclick = () => selectPlayer(i);

      div.innerHTML = `
        <div class="player-header">
          <button class="btn-action btn-delete" onclick="deleteLast(event)">‚àí</button>
          <div class="player-info">
            <strong>${playerNames[i]}</strong>
            <div class="score-line" id="score${i}">${scores[i]}</div>
            <div class="queued-points" id="queued${i}"></div>
          </div>
          <button class="btn-action btn-add" onclick="applyPoints(event); playClick();">+</button>
        </div>
      `;

      if (i === currentPlayer) {
        const buttonGrid = document.createElement("div");
        buttonGrid.className = "button-grid";
        for (let j = 1; j <= 12; j++) {
          const btn = document.createElement("button");
          btn.textContent = j;
          btn.onclick = (e) => {
            e.stopPropagation();
            addToQueue(j);
          };
          buttonGrid.appendChild(btn);
        }
        div.appendChild(buttonGrid);

        const doubleBtn = document.createElement("div");
        doubleBtn.className = "double-button";
        const btn2 = document.createElement("button");
        btn2.textContent = "√ó2";
        btn2.onclick = (e) => {
          e.stopPropagation();
          wrapDouble();
        };
        doubleBtn.appendChild(btn2);
        div.appendChild(doubleBtn);
      }

      container.appendChild(div);
    }
    updateQueuedDisplay();
  }

  function playClick() {
    clickSound.currentTime = 0;
    clickSound.play();
  }

  function addToQueue(val) {
    if (Array.isArray(queue)) {
      queue.push(val);
    } else if (queue && queue.type === 'x2') {
      queue = [queue, val];
    } else {
      queue = [val];
    }
    updateQueuedDisplay();
  }

  function wrapDouble() {
    if (Array.isArray(queue) && queue.length > 0) {
      const valuesToDouble = [...queue];
      queue = [{ type: 'x2', values: valuesToDouble }];
    }
    updateQueuedDisplay();
  }

  function flattenQueue(q) {
    return q.reduce((sum, item) => {
      if (typeof item === 'number') return sum + item;
      if (item.type === 'x2') return sum + 2 * item.values.reduce((a, b) => a + b, 0);
      return sum;
    }, 0);
  }

  function displayQueue(q) {
    return q.map(item => {
      if (typeof item === 'number') return item;
      if (item.type === 'x2') return `2√ó(${item.values.join(' + ')})`;
      return '';
    }).join(' + ');
  }

  function updateQueuedDisplay() {
    for (let i = 0; i < playerNames.length; i++) {
      const el = document.getElementById(`queued${i}`);
      el.innerText = (i === currentPlayer) ? '+ ' + displayQueue(queue) : '';
    }
  }

  function applyPoints(e) {
    e.stopPropagation();
    const total = flattenQueue(queue);
    if (total > 0) {
      scores[currentPlayer] += total;
      history[currentPlayer].push(JSON.parse(JSON.stringify(queue)));
      queue = [];
      currentPlayer = (currentPlayer + 1) % playerNames.length;
      renderPlayers();
    }
  }

  function deleteLast(e) {
    e.stopPropagation();
    if (queue.length > 0) {
      const last = queue[queue.length - 1];
      if (typeof last === 'number') {
        queue.pop();
      } else if (last.type === 'x2' && last.values.length > 0) {
        last.values.pop();
        if (last.values.length === 0) queue.pop();
      }
      updateQueuedDisplay();
    }
  }

  function undo() {
    if (history[currentPlayer].length > 0) {
      const last = history[currentPlayer].pop();
      const sum = flattenQueue(last);
      scores[currentPlayer] -= sum;
      renderPlayers();
    }
  }

  function resetAll() {
    scores = playerNames.map(() => 0);
    history = playerNames.map(() => []);
    queue = [];
    renderPlayers();
  }

  function selectPlayer(i) {
    currentPlayer = i;
    queue = [];
    renderPlayers();
  }

  function addPlayer() {
    const newName = window.prompt("Enter new player name:");
    if (newName && newName.trim().length > 0) {
      playerNames.push(newName.trim());
      scores.push(0);
      history.push([]);
      renderPlayers();
    }
  }

  function deletePlayer() {
    if (playerNames.length > 1) {
      playerNames.splice(currentPlayer, 1);
      scores.splice(currentPlayer, 1);
      history.splice(currentPlayer, 1);
      currentPlayer = currentPlayer % playerNames.length;
      renderPlayers();
    } else {
      alert("At least one player must remain.");
    }
  }

  renderPlayers();
</script>
</body>
</html>
